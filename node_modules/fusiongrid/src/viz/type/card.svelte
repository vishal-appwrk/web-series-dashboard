<script>
  import CardWrapper from "../card/cardWrapper.svelte";
  import { setContext, getContext } from "svelte";

  export let cardLayout, infiniteScrollManager, vizRecDomain, paginationEnabled, gridDimensions, parsedGridConfig, visualUtils;
  const VERTICAL = 'vertical';

  let numCards = cardLayout.numCards,
    startPadding = cardLayout.startPadding,
    numRows,
    element,
    noCardWrappers,
    wrapperIterator,
    numberOfCards,
    dispatchEvent = getContext("dispatchEvent");

  $:{
    // adding 1 otherwise 0th row will be missed
    numRows = vizRecDomain.end - vizRecDomain.start + 1;
    noCardWrappers = Math.ceil(numRows / numCards);
    wrapperIterator = [];
    for (let i = 0; i < noCardWrappers; i++) {
      wrapperIterator.push(i);
    }
  }
  function handleScroll(e){
    // vertical scroll
    infiniteScrollManager.updateHScrollProps(e);
    dispatchEvent('scroll', {
      direction: VERTICAL,
      top: element.scrollTop,
      left: element.scrollLeft
    }, e);
  }
  setContext("cardLayout", cardLayout);
</script>

<div
  class="fg-card-scroller"
  on:scroll={e => handleScroll(e)}
  bind:this={element}
  style="overflow-y: scroll; height: {gridDimensions.height}px;">
  {#each wrapperIterator as startIndex}
    <CardWrapper
      vizStartIndex = {vizRecDomain.start}
      {startIndex}
      incrementer={numCards}
      {startPadding}
      {parsedGridConfig}
      {visualUtils}
      dataLength= {paginationEnabled ? vizRecDomain.end + 1 : infiniteScrollManager.hScrollConfig.dataLength} />
  {/each}
</div>
