<script>
    import { getContext } from 'svelte';
    import BarChart from '../inline-chart/bar.svelte';
    export let carItemIndex;
    export let orderIndex;
    export let parsedGridConfig;
    export let visualUtils;
    let gridData,
      longPressTimer,
      longPressed = false;
    visualUtils.subscribe(util => {
        gridData = util.gridData;
    });
    let cardLayout = getContext('cardLayout'),
        dispatchEvent = getContext("dispatchEvent"),
        numCards = cardLayout.numCards,
        paddingBetweenCards = cardLayout.paddingBetweenCards,
        cardTemplate = cardLayout.cardtemplate,
        columnConfig = gridData.gridConfig.columns,
        headerCellInfos,
        bodyCellInfos,
        getSanitizedInfo = (info)=>{
            let returnObj = {};
            returnObj.classNames = (info.class || []).join(' ');
            returnObj.extStyleStr = '';
            for (let key in (info.style || {})){
                returnObj.extStyleStr += key + ':' + info.style[key] + ';'
            }
            returnObj.content = info.content;
            returnObj.params  = info.params;
            returnObj.inlineChartStyle = info.inlineChartStyle || {};
            return returnObj;
        };
        $:{
            headerCellInfos = [];
            bodyCellInfos = [];
            for (let i = 0; i < columnConfig.length; i++){
                headerCellInfos.push(getSanitizedInfo(gridData.getHeaderMetaInfo(i)));
                bodyCellInfos.push(getSanitizedInfo(gridData.getCellMetaInfo(carItemIndex, i)));
            }
        }
    function handlePointerDown(e) {
        longPressed = false;
        longPressTimer = setTimeout(()=>{
            dispatchEvent('cardlongpressed', {
                cardIndex: carItemIndex,
                cardTemplate 
            }, e);
            longPressed = true;
        }, 500);
    }
    function handlePointerUp(e) {
        clearTimeout(longPressTimer);
        if (!longPressed){
            dispatchEvent('cardclicked', {
                cardIndex: carItemIndex,
                cardTemplate 
            }, e);
            dispatchEvent('recordclicked', {
                recordIndex: carItemIndex
            }, e);
        }
    }
</script>

<div class="fg-card-container" style="width: {cardLayout.width}px; margin-right: {orderIndex !== (numCards - 1) ? paddingBetweenCards + 'px' : ''}"
    on:pointerdown={handlePointerDown} on:pointerup={handlePointerUp}>
        {#if cardTemplate}
	         {@html gridData.getCardHtml(carItemIndex, cardTemplate).content}    
        {:else}
            {#each columnConfig as config, i}
                <div class="fg-data-info-row" style="width:100%">
                    <div class="fg-card-header {headerCellInfos[i].classNames}" style="width:40%;{headerCellInfos[i].extStyleStr}">
                        <div class="fg-card-header-content">
                            {@html headerCellInfos[i].content}
                        </div>
                    </div>  
                    <div class="fg-card-cell {bodyCellInfos[i].classNames}" style="width:60%;{bodyCellInfos[i].extStyleStr}">
                        <div class="fg-card-cell-content">
                        {#if config.type === 'chart'}
                            <BarChart {parsedGridConfig} inlineChartStyle = {bodyCellInfos[i].inlineChartStyle} cellIndex = {i} cellContent= {bodyCellInfos[i].content} scale={config.scale} rowHeight={cardLayout.cellState[i].height} cellState={cardLayout.cellState[i]} cellOrinalVal = {bodyCellInfos[i].params.cellValue}/>
                            {:else}
                                {@html bodyCellInfos[i].content}
                        {/if}
                        </div>
                    </div>  
                </div>
        {/each}       
    {   /if}
    
</div>

