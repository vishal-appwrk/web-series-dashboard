<script>
  import Row from "../row/index.svelte";
  import { getContext, onMount } from "svelte";
  import { flip } from 'svelte/animate';
  export let bodyContainer;
  export let autoHeight;
  export let gridLayout;
  export let hoveredColumnIndex;
  export let hoverInRowIndex;
  export let bodyHeight;
  export let gridData;
  export let vizRecDomain;
  export let parsedGridConfig;
  export let stores;
  export let hoveredGroupDetails;

  const ANIMATION_DURATION = 1000;

	let element,
		hiddenDivHeight,
		totalWidth,
    styleStr,
    dispatchEvent = getContext("dispatchEvent"),
    rowDimensions,
    enableAnimation,
    animateRowsDuration,
    animationRows;
  onMount(() => {
    bodyContainer.node = element;
  });
  $: {
    totalWidth = gridLayout.totalWidth;
    hiddenDivHeight = vizRecDomain.hiddenDivHeight;

    styleStr = autoHeight ? "" : "height:" + bodyHeight + "px;";
    rowDimensions = gridLayout.rowDimState;
    enableAnimation = parsedGridConfig.rowoptions.animaterows !== undefined ? parsedGridConfig.rowoptions.animaterows : false;
    animateRowsDuration = parsedGridConfig.rowoptions.animaterowsduration !== undefined ? parsedGridConfig.rowoptions.animaterowsduration * 1000 : ANIMATION_DURATION;
    animationRows = gridData._gridDataTable._viewData.filter((row, index) => index < rowDimensions.length);
  }
</script>

<div
  class="fg-body-container"
  bind:this={element}
  style={styleStr}>
  <div class="fg-body-scroll-shadow" style="height:{hiddenDivHeight}px" />
  <div class="fg-body-main-content">
    {#if enableAnimation}
    {#each animationRows as row,i(row)}
      <div animate:flip={{duration: animateRowsDuration}}>
        <Row
        animationType={flip}
        {vizRecDomain}
        {gridData}
        {gridLayout}
        type="body"
        rowIndex={i}
        {parsedGridConfig}
        hovered={i === hoverInRowIndex}
        {hoveredGroupDetails}
        style="top:{row.top}px;height:{rowDimensions[i].height}px;width:{totalWidth}px;"
        rowHeight={rowDimensions[i].height}
        {hoveredColumnIndex}
        on:cellHoverIn
        on:cellHoverOut /> 
      </div>
    {/each}
    {:else}
      {#each animationRows as row,i(row)}
        <Row
        animationType={flip}
        {stores}
        {vizRecDomain}
        {gridData}
        {gridLayout}
        type="body"
        rowIndex={i}
        {parsedGridConfig}
        hovered={i === hoverInRowIndex}
        {hoveredGroupDetails}
        style="top:{row.top}px;height:{rowDimensions[i].height}px;width:{totalWidth}px;"
        rowHeight={rowDimensions[i].height}
        {hoveredColumnIndex}
        on:cellHoverIn
        on:cellHoverOut /> 
      {/each}
    {/if}
  </div>
</div>
