<script>
  import InlineChartBar from "../inline-chart/bar.svelte";
  import CheckBox from "../checkbox/body/checkbox.svelte";
  import HelperIcon from "../helperIcon.svelte";
  import { createEventDispatcher } from "svelte";
  import { getContext } from "svelte";

  export let cellIndex;
  export let rowIndex;
  export let style;
  export let rowHeight;
  export let cellState;
  export let hovered;
  export let rowSelectionState;
  export let gridData;
  export let vizRecDomain;
  export let checkBoxEnabled;
  export let parsedGridConfig;
  export let hoveredGroupDetails;

  const BLANKSTRING = '';
  let dataStart = 0,
    dataEnd,
    reduceColumnIndexBy,
    cellElem,
    hoverClass,
    tooltipRef = getContext("tooltipRef"),
    dispatch = createEventDispatcher(),
    columnType,
    cellInfo,
    extClassNames,
    extInlineStyle,
    cellContent,
    cellOrinalVal,
    extInlineStyleStr,
    extHoverClasses,
    extHoverStyle,
    colindex,
    rowindex,
    updatedColIndex,
    scale,
    showHelperIcon,
    showTooltip,
    isSelectionCell,
    tooltipContent = "",
    mergedExtStyle,
    inlineChartStyle,
    isCellHovered;
  $:{
    extInlineStyleStr = "";
    inlineChartStyle = "";
    reduceColumnIndexBy = 0;
    isSelectionCell = checkBoxEnabled && cellIndex == 0;
    if (checkBoxEnabled && cellIndex) {
      reduceColumnIndexBy = 1;
    }
    isCellHovered = hovered || (hoveredGroupDetails && cellIndex >= hoveredGroupDetails.start && cellIndex < hoveredGroupDetails.end);
    updatedColIndex = cellIndex - reduceColumnIndexBy;
    columnType = gridData.gridConfig.columns[updatedColIndex].type;
    dataStart = vizRecDomain.start;
    dataEnd = vizRecDomain.end;
    scale = gridData.gridConfig.columns[updatedColIndex].scale;
    if (!isSelectionCell && dataStart + rowIndex <= dataEnd) {
      cellInfo = gridData.getCellMetaInfo(
        dataStart + rowIndex,
        updatedColIndex
      );
      extClassNames = (cellInfo.class || []).join(" ");
      extInlineStyle = cellInfo.style;
      inlineChartStyle = cellInfo.inlineChartStyle || {};
      cellContent = cellInfo.content;
      cellOrinalVal = cellInfo.params.cellValue;
      colindex = cellInfo.params.cellIndex;
      rowindex = cellInfo.params.rowIndex;
      showHelperIcon = cellInfo.showTooltipInHelper;
      extHoverClasses = cellInfo.hoverClass;
      extHoverStyle = isCellHovered &&  cellInfo.hoverStyle;
      if (Array.isArray(cellInfo.tooltipContent)) {
        showTooltip = cellInfo.tooltipContent.length;
      } else {
        showTooltip = (cellInfo.tooltipContent !== undefined) && (('' + cellInfo.tooltipContent).trim() !== BLANKSTRING);
      }
      if (Array.isArray(cellInfo.tooltipContent)) {
        cellInfo.tooltipContent.forEach(content => (tooltipContent += content));
      } else {
        tooltipContent = cellInfo.tooltipContent;
      }
      if (!tooltipContent) {
        // if no tooltip is provided the do not show the icon
        showHelperIcon = false;
      } else if (showHelperIcon) {
        // else if helper icon is enabled then do not show tooltip in cell hover
        showTooltip = false;
      }
      mergedExtStyle = {...extInlineStyle, ...extHoverStyle};
      for (let key in mergedExtStyle) {
        extInlineStyleStr += key + ":" + mergedExtStyle[key] + ";";
      }
      hoverClass = isCellHovered ? (extHoverClasses.join(" ") || "fg-column-hover ") : ""
    }
  }
  function handleMouseOver(e) {
    (colindex !== undefined) && dispatch("cellHoverIn", { visualColIndex: colindex + reduceColumnIndexBy, rowindex, actualColIndex: colindex });
    showTooltip && tooltipRef.tooltip.show(tooltipContent, e.pageX, e.pageY);
  }
  function handleMouseOut() {
    (colindex !== undefined) && dispatch("cellHoverOut", { visualColIndex: colindex + reduceColumnIndexBy, rowindex, actualColIndex: colindex });
    showTooltip && tooltipRef.tooltip.hide();
  }
  function handleMouseMove(e) {
    // !cellHovered && dispatch('cellHoverIn', { index });
    showTooltip && tooltipRef.tooltip.update(e.pageX, e.pageY);
  }
  
</script>

<div
  class="fg-cell {!isSelectionCell ? (columnType === 'number' ? 'fg-cell-number' : 'fg-cell-string'): ''}
  {extClassNames || ''}
  {hoverClass || ''}"
  style="{style}{extInlineStyleStr}"
  bind:this={cellElem}
  on:mouseover={handleMouseOver}
  on:mousemove={handleMouseMove}
  on:mouseout={handleMouseOut}
  >
  {#if checkBoxEnabled && cellIndex == 0}
    <div class="fg-cell-content fg-cell-content-checkbox">
      <CheckBox {rowSelectionState} />
    </div>
  {:else if columnType === 'chart'}
    <div class="fg-cell-content fg-cell-content-chart">
      <InlineChartBar
        cellIndex = {updatedColIndex}
        {cellContent}
        {scale}
        {rowHeight}
        {cellState}
        {parsedGridConfig}
        {cellOrinalVal}
        {inlineChartStyle} />
    </div>
  {:else}
    <div
      class="fg-cell-content {columnType === 'number' ? 'fg-cell-content-number' : 'fg-cell-content-string'}">
      {#if columnType === 'html'}
        {@html cellContent}
      {:else}
        {cellContent}
      {/if}
    </div>
    {#if showHelperIcon}
      <div class="fg-cell-helper-icon">
        <HelperIcon tooltext={tooltipContent} />
      </div>
    {/if}
  {/if}
</div>
