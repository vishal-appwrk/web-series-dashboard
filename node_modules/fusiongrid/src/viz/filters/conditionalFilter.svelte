<script>
    import SelectDropDown from '../dropdown/select.svelte';
    import { NUMERIC_FIELD_TYPE, STRING_FIELD_TYPE, DATE_FIELD_TYPE, LOGICAL_OPERATORS } from '../../utils/conditionalFilterConstant';
    import InputTextbox from '../textbox/inputText.svelte';
    import InputDate from '../date/inputDate.svelte';
    import CrossIcon from '../icons/cross.svelte';

    export let columnName,
        columnType,
        stores,
        filterRows,
        cellIndex,
        filterMenuStyle;

    let selectOptions = [],
        conditionalFilterValues,
        filterTimeout,
        operatorOptions = [],
        conditionalFilterLogicalOperators,
        crossIconStyle = 'border: none; cursor: pointer; width: 12px; height: 12px;',
        isClearEnabled,
        clearDisabledStyle = 'color: #696A7D; opacity: 50%';
    $: {
        if(columnType === 'number'){
            selectOptions = NUMERIC_FIELD_TYPE.map((condition) => condition.toLowerCase().split('_').join(' '));
        } else if(columnType === 'datetime'){
            selectOptions = DATE_FIELD_TYPE.map((condition) => condition.toLowerCase().split('_').join(' '));
        } else {
            selectOptions = STRING_FIELD_TYPE.map((condition) => condition.toLowerCase().split('_').join(' '));
        }
        operatorOptions = LOGICAL_OPERATORS.map((op) => op.toLowerCase());
        stores.conditionalFilterValues.subscribe((value) => conditionalFilterValues = value);
        stores.conditionalFilterLogicalOperators.subscribe(value => conditionalFilterLogicalOperators = value);
        isClearEnabled = conditionalFilterValues[cellIndex].find((cell) => {
            if((cell.condition && cell.value) || cell.condition === 'between' || cell.condition === 'is within'){
                return true;
            }

            return false;
        })
    }

    function clearTimeOutAndFilter(){
        filterRows();
        filterTimeout = null;
    }

    function updateTextInput(index, field, event){
        let tempConditionalFilterValues,
            {value} = event.target;
        stores.conditionalFilterValues.subscribe((storeValue) => tempConditionalFilterValues = storeValue);
        tempConditionalFilterValues[cellIndex][index][field] = columnType === 'number' && value !== '' && value !== undefined ? Number(event.target.value) : event.target.value;
        stores.conditionalFilterValues.set(tempConditionalFilterValues);

        if(!filterTimeout){
            filterTimeout = setTimeout(() => {
                clearTimeOutAndFilter();
            }, 400);
        }
    }

    function updateConditionChange(index, value) {
        let tempConditionalFilterValues;
        stores.conditionalFilterValues.subscribe((value) => tempConditionalFilterValues = value);
        tempConditionalFilterValues[cellIndex][index].condition = value;
        stores.conditionalFilterValues.set(tempConditionalFilterValues);
        filterRows();
    }

    function updateLogicalOperator(value){
        let tempconditionalFilterLogicalOperators;
        stores.conditionalFilterLogicalOperators.subscribe((filterValue) => tempconditionalFilterLogicalOperators = filterValue);
        tempconditionalFilterLogicalOperators[cellIndex] = value;
        stores.conditionalFilterLogicalOperators.set(tempconditionalFilterLogicalOperators);
        filterRows();
    }

    function addFilter(){
        let tempConditionalFilterValues;
        stores.conditionalFilterValues.subscribe((value) => tempConditionalFilterValues = value);
        tempConditionalFilterValues[cellIndex].push({
            value: ''
        });
        stores.conditionalFilterValues.set(tempConditionalFilterValues);
    }

    function clearFilters(){
        let tempConditionalFilterValues, newConditionalFilterValues = [];
        stores.conditionalFilterValues.subscribe((value) => tempConditionalFilterValues = value);
        newConditionalFilterValues = [...tempConditionalFilterValues];
        newConditionalFilterValues[cellIndex] = [{
            value: ''
        }];
        stores.conditionalFilterValues.set(newConditionalFilterValues);
        filterRows();
    }

    function handleCrossClick(index, e) {
        let tempConditionalFilterValues;
        stores.conditionalFilterValues.subscribe((value) => tempConditionalFilterValues = value);
        tempConditionalFilterValues[cellIndex].splice(index, 1);
        stores.conditionalFilterValues.set(tempConditionalFilterValues);
        filterRows();
    }
</script>

<div style={filterMenuStyle} class="fg-conditional-filter-container">
<div class="fg-contd-wrapper">
{#each conditionalFilterValues[cellIndex] as filterObj,i }
<div class="fg-filter-wrapper">
    <div class="fg-logical-op-container">
        {#if i > 0}
        <span class="fg-deselect-icon" on:click={handleCrossClick.bind(this, i)}>
            <CrossIcon style={crossIconStyle} />
        </span>
        <div class="fg-logical-op">
            <SelectDropDown value={conditionalFilterLogicalOperators[cellIndex]} disabled={i > 1} options={operatorOptions} onChangeHandler={updateLogicalOperator} />
        </div>
        {/if}
    </div>
    <div class="fg-filter-container">
        <span class="fg-filter-column-name">
            {columnName}
        </span>
        <div class="fg-dropdown-container">
            <SelectDropDown value={filterObj.condition} options={selectOptions} placeholder="Condition" onChangeHandler={updateConditionChange.bind(this, i)}/>
        </div>
        <div class="fg-textbox-container" style={filterObj.condition === 'between' || filterObj.condition === 'is within' ? 'width: 40px' : ''}>
            {#if columnType === "datetime"}
                <InputDate style={filterObj.condition === 'between' || filterObj.condition === 'is within' ? 'width: 77%' : ''} disabled={!filterObj.condition || filterObj.condition === 'is empty' || filterObj.condition === 'is not empty'} value={filterObj.value} onChangeHandler={updateTextInput.bind(this, i, 'value')}/>
            {:else}
                <InputTextbox style={filterObj.condition === 'between' || filterObj.condition === 'is within' ? 'width: 77%' : ''} disabled={!filterObj.condition || filterObj.condition === 'is empty' || filterObj.condition === 'is not empty'} value={filterObj.value} onChangeHandler={updateTextInput.bind(this, i, 'value')}/>
            {/if}
        </div>
        {#if filterObj.condition === 'between' || filterObj.condition === 'is within'}
            <span class="fg-dash"></span>
            <div class="fg-textbox-container" style={filterObj.condition === 'between' || filterObj.condition === 'is within' ? 'width: 40px' : ''}>
                {#if columnType === "datetime"}
                    <InputDate style='width: 77%;' disabled={!filterObj.condition} value={filterObj.valueSecond || ''} onChangeHandler={updateTextInput.bind(this, i, 'valueSecond')}/>
                {:else}
                    <InputTextbox style='width: 77%;' disabled={!filterObj.condition} value={filterObj.valueSecond || ''} onChangeHandler={updateTextInput.bind(this, i, 'valueSecond')}/>
                {/if}
            </div>
        {/if}
    </div>
</div>
{/each}
</div>
    <div class="fg-filters-container">
        <span class="fg-add-filter" on:click={addFilter}>+ Add Filter</span>
        <span class="fg-clear-filter" style={isClearEnabled ? '' : clearDisabledStyle} on:click={isClearEnabled ? clearFilters : ''}>Clear Filters</span>
    </div>
</div>