
<script> 
    import CancelSearch from '../icons/cancelSearch.svelte';

    export let filterData;
    export let style;
    export let isChecked;
    export let allSelected;
    export let onChange;
    export let gridData;
    export let colIndex;
    export let columnType;
    export let updateGridOnSearch;
    export let removeIntermediateState;
    export let searchText;
    export let resetSearch;

    let filterBase;

    $:{
      if(searchText){
        filterBase = filterData.filter((data) => {
        let tempData = data ? data.toString() : '';
        return tempData.toLowerCase().includes(searchText.toLowerCase());
      });
      } else {
        filterBase = [...filterData]
      }
    }

    function updateSearchText(value){
      let selectedValues = [];
      filterBase = filterData.filter((data) => {
        let tempData = data ? data.toString() : '';
        return tempData.toLowerCase().includes(value.toLowerCase());
      });

      if(value){
        selectedValues = filterBase.filter((val) => val.toLowerCase().includes(value && value.toLowerCase()) && isChecked.includes(val));
      } else {
        selectedValues = filterBase;
      }
      updateGridOnSearch(selectedValues, value);
    }

    function valuePresentInView(value){
      let tempColumnData = gridData._gridDataTable._viewData.map((row) => row[colIndex]);
      return tempColumnData.find((val) => val === value);
    }

    function clearSearchAndRemoveIntermediateState(){
      filterBase = [...filterData];
      removeIntermediateState();
    }

  </script>

<div class="fg-filter-menu-container" style={style}>
  <div class="fg-filter-search">
    <input type='text' placeholder="Search..." value={searchText || ''} on:input={(e) => updateSearchText(e.target.value)}  />
    {#if searchText}
      <div class="fg-cross-filter-container" on:click={() => updateSearchText('')}>
        <CancelSearch />
      </div>
    {/if}
  </div>
  <div class="fg-filter-selectAll">
    <div class="check-container">
    <label>
      <input class="fg-filter-checkbox" type="checkbox" bind:checked={allSelected} on:change={searchText ? clearSearchAndRemoveIntermediateState : (e) => onChange('_allSelected', e.target.checked)}/>
      {#if searchText}
        <span class="fg-allintermediate-state">
           <span></span>
        </span>
      {:else}
      <span class="geekmark" style='top: 7px'></span>
      {/if}
    </label>
      <span class="fg-row-value"  on:click={searchText ? clearSearchAndRemoveIntermediateState : (e) => onChange('_allSelected', allSelected ? false : true)}> Select All</span>
    </div>
    <span class="fg-clear-value-filter" on:click={() => {
      filterBase = [...filterData];
      resetSearch('_allSelected', true);
    }}>Reset</span>
  </div>
  <div class="fg-filter-values">
      {#each filterBase as value, i}
        {#if isChecked.includes(value) && valuePresentInView(value)}
          <div class='fg-filter-value-row'>
            <label>
            <input class="fg-filter-checkbox" type="checkbox" checked={isChecked.includes(value)} on:change={(e) => onChange(value, e.target.checked)}/>
            <span class="geekmark" style='top: 11px'></span>
            </label>
            <span class="fg-row-value" on:click={(e) => onChange(value, isChecked.includes(value) ? false : true)}>
              {columnType === "datetime" ? new Intl.DateTimeFormat('en-US').format(new Date(value)) : value}
            </span>
          </div>
          {:else if !isChecked.includes(value)}
          <div class='fg-filter-value-row' >
            <label>
            <input class="fg-filter-checkbox" type="checkbox" checked={isChecked.includes(value)} on:change={(e) => onChange(value, e.target.checked)}/>
            <span class="geekmark" style='top: 11px'></span>
          </label>
            <span class="fg-row-value" on:click={(e) => onChange(value, isChecked.includes(value) ? false : true)}>
              {columnType === "datetime" ? new Intl.DateTimeFormat('en-US').format(new Date(value)) : value}
            </span>
          </div>
        {/if}
      {/each}
  </div>
</div>