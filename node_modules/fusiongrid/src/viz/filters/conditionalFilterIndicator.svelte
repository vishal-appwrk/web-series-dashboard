<script>
    import CrossIcon from '../icons/cross.svelte';

    export let stores,
        applyConditionalFilter,
        gridData;

    let conditionalFilterValues,
        conditionalFilterLogicalOperator,
        filtersArray = [],
        crossIconStyle = 'border: none; cursor: pointer; width: 12px; height: 12px; vertical-align: middle;',
        isContainerRequired = false,
        schema;

    $:{
        filtersArray = [];
        schema = gridData._gridDataTable._schema;
        stores.conditionalFilterValues.subscribe((value) => conditionalFilterValues = value);
        stores.conditionalFilterLogicalOperators.subscribe((value) => conditionalFilterLogicalOperator = value);
        conditionalFilterValues.map((column, index) => {
            let tempArr = [];
            column.map((cell) => {
                if((cell.condition && cell.value) || (cell.condition === 'is empty' || cell.condition === 'is not empty')){
                    let conditionString  = cell.condition;
                    if(cell.value){
                        conditionString += ' "' + cell.value + '" '
                    }

                    if(cell.condition === 'between' || cell.condition === 'is within'){
                        conditionString += 'to' + ' "' + cell.valueSecond + '" '
                    }
                    tempArr.push(conditionString);
                } 
                return '';
            });
            filtersArray.push(tempArr);
        })
        isContainerRequired = filtersArray.find((val) => val.length);
    }

    function clearFilterCondition(index, e){
        let tempFilters = [{
            value: ''
        }], tempConditionalFilterValues;
        stores.conditionalFilterValues.subscribe((value) => tempConditionalFilterValues = value);
        tempConditionalFilterValues[index] = tempFilters;
        stores.conditionalFilterValues.set(tempConditionalFilterValues);
        applyConditionalFilter();
    }

    function handleClearAll() {
        let tempConditionalFilterValues;
        stores.conditionalFilterValues.subscribe((value) => tempConditionalFilterValues = value);
        stores.conditionalFilterValues.set(tempConditionalFilterValues.map((val) => [{ value: '' }]));
        applyConditionalFilter();
    }
</script>

<div class="fg-global-conditions-wrapper">
    {#if isContainerRequired}
    <div>
        {#each filtersArray as columnFilter, i}
            {#if columnFilter.length}
            <div class="fg-conditions-container">
                <div class="fg-condition-text">
                    <span class="fg-bold-content">{schema[i].name + ':'}</span>&nbsp;
                    {#each columnFilter as cellFilter, j}
                        {#if j !== 0}
                            &nbsp;<span class="fg-bold-content">{conditionalFilterLogicalOperator[i]}</span>&nbsp;
                        {/if}
                        <span>{cellFilter}</span>
                    {/each}
                </div>
                <span on:click={clearFilterCondition.bind(this, i)}>
                    <CrossIcon style={crossIconStyle} />
                </span>
            </div>
            {/if}
        {/each}
    </div>
    <div class="fg-global-clear-all" on:click={handleClearAll}>
        <span>Clear All Filters</span></div>
    {/if}
</div>